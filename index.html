<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            font: 12px Arial;
        }

        div.tooltip {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            position: absolute;
            display: none;
            width: auto;
            height: auto;
            border: 0 none;
            box-shadow: 0px 5px 15px 0px rgba(0, 0, 0, 0.3);
            border-radius: 8px 8px 8px 8px;
            color: black;
            font: 12px sans-serif;
            padding: 5px;
            text-align: center;
        }

        .overlay {
            fill: none;
            pointer-events: all;
        }

        #map {
            float: left;
            width: 45%;
            border: 1px solid black;
            border-radius: 5px;
            margin-left: 30px;
            margin-top: 20px;


        }

        #line {
            float: left;
            width: 50%;
            margin-left: 30px;
            margin-top: 10px;


        }

        #line2 {
            float: left;
            width: 50%;
            margin-left: 30px;
            margin-top: 20px;


        }

        .container {
            width: 100%;
            height: 100%;
        }
    </style>
    <meta charset="UTF-8">
    <title>Visual Analytics - Health Care Visualization</title>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <!-- CSS -->
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <!-- jQuery and JS bundle w/ Popper.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
            crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/jquery.dropdown.min.css">
    <script src="assets/jquery.dropdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
</head>
<body>
<section class="section">
    <div class="container">
        <div class="row">
            <h1 class="title col-lg">
                Health Care Spending
            </h1>
        </div>
        <div class="row">
            <!-- Countries list for q3-->
            <div id="countries-select" class="col-lg">
                <select id="countries-select-q3" style="display:none" name="countries" multiple placeholder="Select">
                    <option value="Afghanistan">Afghanistan</option>
                    <option value="Algeria">Algeria</option>
                    <option value="Andorra">Andorra</option>
                    <option value="Angola">Angola</option>
                    <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                    <option value="Argentina">Argentina</option>
                    <option value="Armenia">Armenia</option>
                    <option value="Australia">Australia</option>
                    <option value="Austria">Austria</option>
                    <option value="Azerbaijan">Azerbaijan</option>
                    <option value="Bahamas">Bahamas</option>
                    <option value="Bahrain">Bahrain</option>
                    <option value="Bangladesh">Bangladesh</option>
                    <option value="Barbados">Barbados</option>
                    <option value="Belarus">Belarus</option>
                    <option value="Belgium">Belgium</option>
                    <option value="Belize">Belize</option>
                    <option value="Benin">Benin</option>
                    <option value="Bhutan">Bhutan</option>
                    <option value="Bolivia">Bolivia</option>
                    <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                    <option value="Botswana">Botswana</option>
                    <option value="Brazil">Brazil</option>
                    <option value="Brunei Darussalam">Brunei Darussalam</option>
                    <option value="Bulgaria">Bulgaria</option>
                    <option value="Burkina Faso">Burkina Faso</option>
                    <option value="Burundi">Burundi</option>
                    <option value="Cabo Verde">Cabo Verde</option>
                    <option value="Cambodia">Cambodia</option>
                    <option value="Cameroon">Cameroon</option>
                    <option value="Canada">Canada</option>
                    <option value="Chad">Chad</option>
                    <option value="Chile">Chile</option>
                    <option value="China">China</option>
                    <option value="Colombia">Colombia</option>
                    <option value="Comoros">Comoros</option>
                    <option value="Congo">Congo</option>
                    <option value="Costa Rica">Costa Rica</option>
                    <option value="Cote d'Ivoire">Cote d'Ivoire</option>
                    <option value="Croatia">Croatia</option>
                    <option value="Cuba">Cuba</option>
                    <option value="Cyprus">Cyprus</option>
                    <option value="Czech Republic">Czech Republic</option>
                    <option value="Denmark">Denmark</option>
                    <option value="Djibouti">Djibouti</option>
                    <option value="Dominica">Dominica</option>
                    <option value="Dominican Republic">Dominican Republic</option>
                    <option value="Ecuador">Ecuador</option>
                    <option value="Egypt">Egypt</option>
                    <option value="El Salvador">El Salvador</option>
                    <option value="Equatorial Guinea">Equatorial Guinea</option>
                    <option value="Eritrea">Eritrea</option>
                    <option value="Estonia">Estonia</option>
                    <option value="Eswatini">Eswatini</option>
                    <option value="Ethiopia">Ethiopia</option>
                    <option value="Fiji">Fiji</option>
                    <option value="Finland">Finland</option>
                    <option value="France">France</option>
                    <option value="Gabon">Gabon</option>
                    <option value="Gambia">Gambia</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Germany">Germany</option>
                    <option value="Ghana">Ghana</option>
                    <option value="Greece">Greece</option>
                    <option value="Grenada">Grenada</option>
                    <option value="Guatemala">Guatemala</option>
                    <option value="Guinea">Guinea</option>
                    <option value="Guinea-Bissau">Guinea-Bissau</option>
                    <option value="Guyana">Guyana</option>
                    <option value="Haiti">Haiti</option>
                    <option value="Honduras">Honduras</option>
                    <option value="Hungary">Hungary</option>
                    <option value="Iceland">Iceland</option>
                    <option value="India">India</option>
                    <option value="Indonesia">Indonesia</option>
                    <option value="Iran">Iran</option>
                    <option value="Iraq">Iraq</option>
                    <option value="Ireland">Ireland</option>
                    <option value="Israel">Israel</option>
                    <option value="Italy">Italy</option>
                    <option value="Jamaica">Jamaica</option>
                    <option value="Japan">Japan</option>
                    <option value="Jordan">Jordan</option>
                    <option value="Kazakhstan">Kazakhstan</option>
                    <option value="Kenya">Kenya</option>
                    <option value="Kiribati">Kiribati</option>
                    <option value="Korea">Korea</option>
                    <option value="Kuwait">Kuwait</option>
                    <option value="Kyrgyz Republic">Kyrgyz Republic</option>
                    <option value="Lao PDR">Lao PDR</option>
                    <option value="Latvia">Latvia</option>
                    <option value="Lebanon">Lebanon</option>
                    <option value="Lesotho">Lesotho</option>
                    <option value="Liberia">Liberia</option>
                    <option value="Libya">Libya</option>
                    <option value="Lithuania">Lithuania</option>
                    <option value="Luxembourg">Luxembourg</option>
                    <option value="Madagascar">Madagascar</option>
                    <option value="Malawi">Malawi</option>
                    <option value="Malaysia">Malaysia</option>
                    <option value="Maldives">Maldives</option>
                    <option value="Mali">Mali</option>
                    <option value="Malta">Malta</option>
                    <option value="Marshall Islands">Marshall Islands</option>
                    <option value="Mauritania">Mauritania</option>
                    <option value="Mauritius">Mauritius</option>
                    <option value="Mexico">Mexico</option>
                    <option value="Micronesia">Micronesia</option>
                    <option value="Moldova">Moldova</option>
                    <option value="Monaco">Monaco</option>
                    <option value="Mongolia">Mongolia</option>
                    <option value="Morocco">Morocco</option>
                    <option value="Mozambique">Mozambique</option>
                    <option value="Myanmar">Myanmar</option>
                    <option value="Namibia">Namibia</option>
                    <option value="Nauru">Nauru</option>
                    <option value="Nepal">Nepal</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="New Zealand">New Zealand</option>
                    <option value="Nicaragua">Nicaragua</option>
                    <option value="Niger">Niger</option>
                    <option value="Nigeria">Nigeria</option>
                    <option value="North America">North America</option>
                    <option value="North Macedonia">North Macedonia</option>
                    <option value="Norway">Norway</option>
                    <option value="Oman">Oman</option>
                    <option value="Pakistan">Pakistan</option>
                    <option value="Palau">Palau</option>
                    <option value="Panama">Panama</option>
                    <option value="Papua New Guinea">Papua New Guinea</option>
                    <option value="Paraguay">Paraguay</option>
                    <option value="Peru">Peru</option>
                    <option value="Philippines">Philippines</option>
                    <option value="Poland">Poland</option>
                    <option value="Portugal">Portugal</option>
                    <option value="Qatar">Qatar</option>
                    <option value="Romania">Romania</option>
                    <option value="Russian Federation">Russian Federation</option>
                    <option value="Rwanda">Rwanda</option>
                    <option value="Samoa">Samoa</option>
                    <option value="San Marino">San Marino</option>
                    <option value="Sao Tome and Principe">Sao Tome and Principe</option>
                    <option value="Saudi Arabia">Saudi Arabia</option>
                    <option value="Senegal">Senegal</option>
                    <option value="Serbia">Serbia</option>
                    <option value="Seychelles">Seychelles</option>
                    <option value="Sierra Leone">Sierra Leone</option>
                    <option value="Singapore">Singapore</option>
                    <option value="Slovak Republic">Slovak Republic</option>
                    <option value="Slovenia">Slovenia</option>
                    <option value="Solomon Islands">Solomon Islands</option>
                    <option value="South Africa">South Africa</option>
                    <option value="Spain">Spain</option>
                    <option value="Sri Lanka">Sri Lanka</option>
                    <option value="St. Kitts and Nevis">St. Kitts and Nevis</option>
                    <option value="St. Lucia">St. Lucia</option>
                    <option value="St. Vincent and the Grenadines">St. Vincent and the Grenadines</option>
                    <option value="Sudan">Sudan</option>
                    <option value="Suriname">Suriname</option>
                    <option value="Sweden">Sweden</option>
                    <option value="Switzerland">Switzerland</option>
                    <option value="Syrian Arab Republic">Syrian Arab Republic</option>
                    <option value="Tajikistan">Tajikistan</option>
                    <option value="Tanzania">Tanzania</option>
                    <option value="Thailand">Thailand</option>
                    <option value="Timor-Leste">Timor-Leste</option>
                    <option value="Togo">Togo</option>
                    <option value="Tonga">Tonga</option>
                    <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                    <option value="Tunisia">Tunisia</option>
                    <option value="Turkey">Turkey</option>
                    <option value="Turkmenistan">Turkmenistan</option>
                    <option value="Tuvalu">Tuvalu</option>
                    <option value="Uganda">Uganda</option>
                    <option value="Ukraine">Ukraine</option>
                    <option value="United Arab Emirates">United Arab Emirates</option>
                    <option value="United Kingdom">United Kingdom</option>
                    <option value="United States">United States</option>
                    <option value="Uruguay">Uruguay</option>
                    <option value="Uzbekistan">Uzbekistan</option>
                    <option value="Vanuatu">Vanuatu</option>
                    <option value="Venezuela">Venezuela</option>
                    <option value="Vietnam">Vietnam</option>
                    <option value="Yemen">Yemen</option>
                    <option value="Zambia">Zambia</option>
                    <option value="Zimbabwe">Zimbabwe</option>
                </select>
            </div>
        </div>
        <div class="row">
            <button type="button" class="btn btn-outline-success btn-lg btn-block col-lg" id="plot-button-q3">Plot
            </button>
        </div>
        <div class="row">
            <div class="alert alert-danger alert-dismissible fade col-lg" id="not-implemented">
                <strong>Oops!</strong> Dynamic selection not developed yet, stay tuned!
                <button type="button" class="close" aria-label="Close" id="not-implemented-close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
        <div class="row">
            <div id='gdpDiv'>
                <!-- Plot for Health Care spending as % of GDP -->
            </div>
        </div>
        <div class="row">
            <div id='oopDiv'>
                <!-- Plot for Health Care spending as % of GDP -->
            </div>
        </div>
        <div class="row">
            <h1>If the financial aid the government received contributes to people's health?</h1>
            <p>Click the country on the map to compare the received financial aid and the Health expenditure per capital
                from 2008 to 2018. Hover the line chart can see the amount for each year.</p>
            <div class="container">
                <svg id="map" width="800" height="400"></svg>
                <svg id="line" width="550" height="200"></svg>
                <svg id="line2" width="550" height="200"></svg>
            </div>
        </div>
</section>
<script>
    let plotly_country_selection;
    let q3_data = new Map()
    let q4_data = new Map()
    const q3_q4_years = [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017]
    $(document).ready(function () {
        initialize();
        drop_down();
        events();
        utilization_chart();
    });

    function initialize() {
        plotly_country_selection = ['Armenia', 'Spain', 'France', 'India', 'China'];
        d3.csv("https://raw.githubusercontent.com/gayanehvardanyan/Visual-Analytics-Project/main/assets/q3_source.csv").get(function (errors, data) {
            data.forEach(x => {
                q3_data.set(x["Country Name"], q3_q4_years.map(y => parseFloat(x[y]).toFixed(2)));
            });
            q3_gdp_plot();
        });
        d3.csv("https://raw.githubusercontent.com/gayanehvardanyan/Visual-Analytics-Project/main/assets/q4_source.csv").get(function (errors, data) {
            data.forEach(x => {
                q4_data.set(x["Country"], q3_q4_years.map(y => parseFloat(x[y]).toFixed(2)));
            });
            q4_oop_plot();
        });
    }


    function events() {
        $('#plot-button-q3').click(function () {
            q3_gdp_plot();
            q4_oop_plot();
        });
    }

    function drop_down() {
        // plugin from https://www.jqueryscript.net/form/Searchable-Multi-select-jQuery-Dropdown.html
        let a = $('#countries-select').dropdown({
            readOnly: true,
            minCount: 2,
            minCountErrorMessage: 'Choose at-least 2 countries',
            limitCount: 5,
            limitCountErrorMessage: 'Choose a Maximum of 5 countries',
            input: '<input type="text" maxLength="20" placeholder="Search">',
            multipleMode: 'label',
            searchable: true,
            searchNoData: '<li style="color:#ddd">No Results</li>',
            choice: function () {
                plotly_country_selection = this.config.data.filter(x => x.selected).map(x => x.id)
            },
            extendProps: []
        });
        $("#countries-select-q3 option").removeAttr("selected");
    }

    function utilization_chart() {
        var svg = d3.select("#map"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

// Map and projection
        var path = d3.geoPath();
        var projection = d3.geoMercator()
            .scale(100)
            .center([135, 17])
        //.translate([width / 2, height / 2]);

//Data and color scale
        var data = d3.map();
        var colorScale = d3.scaleThreshold()
            .domain([0, 3, 6, 9, 12, 15, 18])
            .range(d3.schemeBlues[8]);

        d3.queue()
            .defer(d3.json, "https://raw.githubusercontent.com/YuhsuanChen/dataset/main/geo.json")
            .defer(d3.csv, "https://raw.githubusercontent.com/YuhsuanChen/dataset/main/death_rate.csv", function (d) {
                data.set(d.Country_Code, [d.Country_Name, +d.years_sum]);
            })
            .await(mapChart);
        console.log

        function mapChart(error, topo) {

            //Draw the map
            svg.append("g")
                .selectAll("path")
                .data(topo.features)
                .enter()
                .append("path")
                // draw each country
                .attr("d", d3.geoPath()
                    .projection(projection)
                )
                // set the color of each country

                .attr("fill", function (d) {
                    d.value = data.get(d.id)
                    if (typeof d.value !== 'undefined') {
                        //console.log(d.value[1])
                        d.total = d.value[1] || 0;
                    } else {
                        d.total = 0
                    }
                    return colorScale(d.total);

                })
                .style("stroke", "transparent")
                .attr("class", function (d) {
                    return "Country_Code"
                })
                .style("opacity", .8)
                .on("mouseover", mouseOver)
                .on("mouseleave", mouseLeave)
                .on("click", up)
        }

        var mouseOver = function (d) {


            d3.select(this)
                .transition()
                .style("opacity", 1)
                .style("stroke", "black")

            var text = svg.append("text")
                .attr("x", (width / 2) + 10)
                .attr("y", (height - 10))
                .attr("text-anchor", "middle")
                .style("font-size", "11px")
                .attr("id", "mapTitle")
                .text(data.get(d.id)[0] + ", death rate: " + data.get(d.id)[1] + " per 1000 people");
        }

        var mouseLeave = function (d) {
            d3.selectAll(".Country_Code")
                .transition()
                .style("opacity", .8)
                .style("stroke", "transparent")
            mapTitle.remove()

        }

        function up(d, i) {
            var selectedCountry = data.get(d.id)[0];
            d3.selectAll("#lineline").remove();
            d3.selectAll("#lineChartTitle").remove();
            createLine_received(selectedCountry);
            createLine_spend(selectedCountry);
        }


        function createLine_received(selectedCountry) {

// set the dimensions and margins of the graph
            var margin = {top: 30, right: 80, bottom: 30, left: 90},
                width = 600 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;

// append the svg object to the body of the page
            var svg = d3.select("#line")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleTime().range([0, width]);
            var y = d3.scaleLinear().range([height, 0]);
            var bisectDate = d3.bisector(function (d) {
                return d.Year;
            }).left;


//Read the data
            d3.csv("https://raw.githubusercontent.com/YuhsuanChen/dataset/main/linechart_year_updated.csv", function (data) {

                var parseTime = d3.timeParse("%Y")

                var myColor = d3.scaleOrdinal()
                    //.domain(allGroup)
                    .range(d3.schemeSet2);

                // Add X axis --> it is a date format
                x = d3.scaleLinear()
                    .domain(d3.extent(data, function (d) {
                        return d.Year;
                    }))
                    .range([0, width]);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).ticks(10));

                // Add Y axis
                y = d3.scaleLinear()
                    .domain([d3.min(data, function (d) {
                        return +d.Value;
                    }) / 1.005,
                        d3.max(data, function (d) {
                            return +d.Value;
                        }) * 1.005])
                    .range([height, 0])
                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5))
                    .append("text")
                    .attr("class", "axis-title")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .attr("fill", "#5D6971")
                    .text("US$");

                var text = svg.append("text")
                    .attr("x", (width / 2))
                    .attr("y", 0 - (margin.top / 2))
                    .attr("text-anchor", "middle")
                    .style("font-size", "16px")
                    .style("text-decoration", "underline")
                    .attr("id", "lineChartTitle")
                    .text("Financial aid received, " + selectedCountry);


                // Initialize line with first group of the list
                var line = svg
                    .append('g')
                    .append("path")
                    .datum(data.filter(function (d) {
                        return d.Country_Name == selectedCountry
                    }))
                    .attr("d", d3.line()
                        .x(function (d) {
                            return x(d.Year)
                        })
                        .y(function (d) {
                            return y(+d.Value)
                        })
                    )
                    .attr("id", "lineline")
                    .attr("stroke", function (d) {
                        return myColor("valueA")
                    })
                    .style("stroke-width", 4)
                    .style("fill", "none");

                var focus = svg
                    .append('g')
                    .attr("class", "focus")
                    .style("display", "none");

                focus.append("line")
                    .attr("class", "x-hover-line hover-line")
                    .attr("y1", 0)
                    .attr("y2", height)
                    .attr("stroke", function (d) {
                        return myColor("valueA")
                    })
                    .style("stroke-dasharray", 3);

                focus.append("line")
                    .attr("class", "y-hover-line hover-line")
                    .attr("x1", width)
                    .attr("x2", width)
                    .attr("stroke", function (d) {
                        return myColor("valueA")
                    })
                    .style("stroke-dasharray", 3);

                focus.append("circle")
                    .attr("fill", function (d) {
                        return myColor("valueA")
                    })
                    .attr("stroke", function (d) {
                        return myColor("valueA")
                    })
                    .attr("r", 5);

                focus.append("text")
                    .attr("x", 5)
                    .attr("dy", ".31em");

                var rect = svg.append("rect")
                    .attr("transform", "translate(" + margin.top + ")")
                    .attr("class", "overlay")
                    .attr("width", width + 50)
                    .attr("height", height)
                    .on("mouseover", function () {
                        focus.style("display", null);
                    })
                    .on("mouseout", function () {
                        focus.style("display", "none");
                    })
                    .on("mousemove", mousemove);

                function mousemove() {
                    var filtered_data = data.filter(function (d) {
                        return d.Country_Name == selectedCountry
                    });
                    var x0 = x.invert(d3.mouse(this)[0])
                    i = bisectDate(filtered_data, x0, 1);
                    d0 = filtered_data[i - 1];
                    d1 = filtered_data[i];
                    if (typeof d1 !== 'undefined') {
                        d = x0 - d0.year > d1.year - x0 ? d1 : d0;

                    } else {
                        d = filtered_data[10]
                    }
                    focus.attr("transform", "translate(" + x(d.Year) + "," + y(d.Value) + ")");
                    focus.select("text").text(function () {
                        return d.Value;
                    });
                    focus.select(".x-hover-line").attr("y2", height - y(d.Value));
                    focus.select(".y-hover-line").attr("x2", width + width);

                }

            })


        }

        function createLine_spend(selectedCountry) {

// set the dimensions and margins of the graph
            var margin = {top: 30, right: 80, bottom: 30, left: 90},
                width = 600 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;

// append the svg object to the body of the page
            var svg = d3.select("#line2")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleTime().range([0, width]);
            var y = d3.scaleLinear().range([height, 0]);
            var bisectDate = d3.bisector(function (d) {
                return d.Year;
            }).left;


//Read the data
            d3.csv("https://raw.githubusercontent.com/YuhsuanChen/dataset/main/linechart_spending.csv", function (data) {
                // List of groups (here I have one group per column)
                // var allGroup = d3.map(data, function(d){return(d.Country_Name)}).keys()

                var parseTime = d3.timeParse("%Y")

                var myColor = d3.scaleOrdinal()
                    //.domain(allGroup)
                    .range(d3.schemeSet2);

                // Add X axis --> it is a date format
                x = d3.scaleLinear()
                    .domain(d3.extent(data, function (d) {
                        return d.Year;
                    }))
                    .range([0, width]);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).ticks(10));

                // Add Y axis
                y = d3.scaleLinear()
                    .domain([d3.min(data, function (d) {
                        return +d.Value;
                    }) / 1.005,
                        d3.max(data, function (d) {
                            return +d.Value;
                        }) * 1.005])
                    .range([height, 0])
                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5))
                    .append("text")
                    .attr("class", "axis-title")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .attr("fill", "#5D6971")
                    .text("US$");

                var text = svg.append("text")
                    .attr("x", (width / 2))
                    .attr("y", 0 - (margin.top / 2))
                    .attr("text-anchor", "middle")
                    .style("font-size", "16px")
                    .style("text-decoration", "underline")
                    .attr("id", "lineChartTitle")
                    .text("Health expenditure per capital, " + selectedCountry);


                // Initialize line with first group of the list
                var line = svg
                    .append('g')
                    .append("path")
                    .datum(data.filter(function (d) {
                        return d.Country_Name == selectedCountry
                    }))
                    .attr("d", d3.line()
                        .x(function (d) {
                            return x(d.Year)
                        })
                        .y(function (d) {
                            return y(+d.Value)
                        })
                    )
                    .attr("id", "lineline")
                    .attr("stroke", function (d) {
                        return myColor("valueA")
                    })
                    .style("stroke-width", 4)
                    .style("fill", "none");

                var focus = svg
                    .append('g')
                    .attr("class", "focus")
                    .style("display", "none");

                focus.append("line")
                    .attr("class", "x-hover-line hover-line")
                    .attr("y1", 0)
                    .attr("y2", height)
                    .attr("stroke", function (d) {
                        return myColor("valueA")
                    })
                    .style("stroke-dasharray", 3);

                focus.append("line")
                    .attr("class", "y-hover-line hover-line")
                    .attr("x1", width)
                    .attr("x2", width)
                    .attr("stroke", function (d) {
                        return myColor("valueA")
                    })
                    .style("stroke-dasharray", 3);

                focus.append("circle")
                    .attr("fill", function (d) {
                        return myColor("valueA")
                    })
                    .attr("stroke", function (d) {
                        return myColor("valueA")
                    })
                    .attr("r", 5);

                focus.append("text")
                    .attr("x", 5)
                    .attr("dy", ".31em");

                var rect = svg.append("rect")
                    .attr("transform", "translate(" + margin.top + ")")
                    .attr("class", "overlay")
                    .attr("width", width + 50)
                    .attr("height", height)
                    .on("mouseover", function () {
                        focus.style("display", null);
                    })
                    .on("mouseout", function () {
                        focus.style("display", "none");
                    })
                    .on("mousemove", mousemove);

                function mousemove() {
                    var filtered_data = data.filter(function (d) {
                        return d.Country_Name == selectedCountry
                    });
                    var x0 = x.invert(d3.mouse(this)[0])
                    i = bisectDate(filtered_data, x0, 1);
                    d0 = filtered_data[i - 1];
                    d1 = filtered_data[i];
                    if (typeof d1 !== 'undefined') {
                        d = x0 - d0.year > d1.year - x0 ? d1 : d0;

                    } else {
                        d = filtered_data[10]
                    }
                    focus.attr("transform", "translate(" + x(d.Year) + "," + y(d.Value) + ")");
                    focus.select("text").text(function () {
                        return d.Value;
                    });
                    focus.select(".x-hover-line").attr("y2", height - y(d.Value));
                    focus.select(".y-hover-line").attr("x2", width + width);

                }

            })
        }
    }

    function country_line_plot(xData, yData, title, divId, label_terminator) {
        const lastDataIndex = xData[0].length - 1;

        let markerSize = Array(xData[0].length).fill(10)
        markerSize[0] = 20
        markerSize[lastDataIndex] = 20

        const colors = ['rgba(255, 113, 206, 1)', 'rgba(82, 191, 144, 1)', 'rgba(136, 118, 236, 1)', 'rgba(148, 223, 243, 1)', 'rgba(59, 89, 152, 1)',];

        const lineSize = [4, 4, 4, 4, 4];

        const labels = plotly_country_selection;

        const data = [];
        let i = 0;
        for (i = 0; i < xData.length; i++) {
            const lineMark = {
                x: xData[i],
                y: yData[i],
                type: 'scatter',
                mode: 'lines + markers',
                line: {
                    color: colors[i],
                    width: lineSize[i]
                },
                marker: {
                    color: colors[i],
                    size: markerSize
                },
                name: labels[i],
                hoverInfo: "x",
            }
            data.push(lineMark);
        }

        const layout = {
            showlegend: false,
            height: 800,
            width: 1000,
            xaxis: {
                showline: true,
                showgrid: false,
                showticklabels: true,
                linecolor: 'rgb(204,204,204)',
                linewidth: 2,
                autotick: false,
                ticks: 'outside',
                tickcolor: 'rgb(204,204,204)',
                tickwidth: 2,
                ticklen: 5,
                tickfont: {
                    family: 'Arial',
                    size: 12,
                    color: 'rgb(82, 82, 82)'
                }
            },
            yaxis: {
                showgrid: false,
                zeroline: false,
                showline: false,
                showticklabels: false
            },
            autosize: true,
            margin: {
                autoexpand: true,
                l: 100,
                r: 20,
                t: 100
            },
            annotations: [
                {
                    xref: 'paper',
                    yref: 'paper',
                    x: 0.25,
                    y: 1.05,
                    xanchor: 'left',
                    yanchor: 'center',
                    text: title,
                    font: {
                        family: 'Arial',
                        size: 30,
                        color: 'rgb(37,37,37)'
                    },
                    showarrow: false
                }
            ]
        };

        for (i = 0; i < xData.length; i++) {
            let yLeft = 0
            for (let j = 0; j < yData[i].length; j++) {
                let elem = yData[i][j]
                if (!isNaN(elem)) {
                    yLeft = j;
                    break;
                }
            }
            let yRight = lastDataIndex;
            for (let j = lastDataIndex; j > -1; j--) {
                let elem = yData[i][j]
                if (!isNaN(elem)) {
                    yRight = j;
                    break;
                }
            }
            const leftMargin = {
                xref: 'paper',
                x: 0.05 + 0.05 * (yLeft),
                y: yData[i][yLeft],
                xanchor: 'right',
                yanchor: 'middle',
                text: labels[i] + ' ' + yData[i][yLeft] + label_terminator,
                showarrow: false,
                font: {
                    family: 'Arial',
                    size: 16,
                    color: 'black'
                }
            };
            const rightMargin = {
                xref: 'paper',
                x: 0.95 - 0.05 * (lastDataIndex - yRight),
                y: yData[i][yRight],
                xanchor: 'left',
                yanchor: 'middle',
                text: yData[i][yRight] + label_terminator,
                font: {
                    family: 'Arial',
                    size: 16,
                    color: 'black'
                },
                showarrow: false
            };

            layout.annotations.push(leftMargin, rightMargin);
        }
        Plotly.newPlot(divId, data, layout, {displaylogo: false, displayModeBar: false});
    }

    function q3_gdp_plot() {
        const gdpData = plotly_country_selection.map(x => q3_data.get(x))
        let xData = [];
        for (let i = 0; i < plotly_country_selection.length; i++) {
            xData.push(q3_q4_years);
        }
        country_line_plot(xData, gdpData, 'Health Expenditure (% of GDP)', 'gdpDiv', '%');
    }

    function q4_oop_plot() {
        const oopData = plotly_country_selection.map(x => q4_data.get(x))
        let xData = [];
        for (let i = 0; i < plotly_country_selection.length; i++) {
            xData.push(q3_q4_years);
        }
        country_line_plot(xData, oopData, 'Out of Pocket Medical Expense (USD)', 'oopDiv', '$');
    }
</script>
<div class="container">
        <canvas id="num_beds"></canvas>
</div>
<script src="./num_beds.js"></script>
</body>
</html>